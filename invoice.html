<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invoice - Dejede Photography</title>
    
    <!-- SEO -->
    <meta name="description" content="Invoice Generator | Dejede Photography">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Invoice - Dejede">
    <meta property="og:image" content="https://raw.githubusercontent.com/dejede/dejedephotography/main/images/logo.png">
    <meta property="og:url" content="https://dejede.github.io/dejedephotography/">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="style-2.css">
    <link rel="icon" href="./favicon/favicon.ico">
    <meta name="theme-color" content="#3e5241">
</head>

<body>
<!-- FLOATING CONTROLS - IMPROVED -->
<div class="controls-wrapper no-print">
    <div class="controls-container">

        <!-- SIMPAN -->
        <button class="btn btn-save" data-action="save">
            <span class="btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V7l4-4h10l4 4v12a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
            </span>
            <span class="btn-text">Simpan</span>
        </button>

        <!-- WHATSAPP -->
        <button class="btn btn-wa" data-action="whatsapp">
            <span class="btn-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.52 3.48A11.91 11.91 0 0012.04 0C5.38 0 .01 5.37 0 12.03a11.9 11.9 0 001.64 6.03L0 24l6.11-1.6a11.98 11.98 0 005.93 1.52h.01c6.66 0 12.03-5.37 12.03-12.03 0-3.21-1.25-6.23-3.56-8.41z"/>
                </svg>
            </span>
            <span class="btn-text">WhatsApp</span>
        </button>

        <!-- TAMBAH -->
        <button class="btn btn-add" data-action="add-row">
            <span class="btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </span>
            <span class="btn-text">Tambah</span>
        </button>

        <!-- CETAK -->
        <button class="btn btn-print" data-action="print">
            <span class="btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 6 2 18 2 18 9"/>
                    <path d="M6 18h12v4H6z"/>
                    <rect x="3" y="9" width="18" height="9" rx="2"/>
                </svg>
            </span>
            <span class="btn-text">Cetak</span>
        </button>

    </div>
</div>

    <!-- INVOICE CONTAINER -->
    <div id="invoice-container">
        <!-- WATERMARK LUNAS -->
        <div id="paidWatermark" aria-hidden="true"></div>

        <!-- HEADER SECTION -->
        <header class="header">
            <div class="brand-box">
                <img src="https://raw.githubusercontent.com/dejede/dejedephotography/main/images/logo.png" 
                     alt="Dejede Photography Logo" crossorigin="anonymous">
                <div class="brand-text">
                    <h1>DEJEDE</h1>
                    <p>Capturing Your Story</p>
                </div>
            </div>
            <div class="inv-meta">
                <h2>INVOICE</h2>
                <input type="text" id="invoiceNum" readonly aria-label="Nomor Invoice" 
                       placeholder="INV/DEJEDE/000000">
            </div>
        </header>

        <!-- CLIENT INFO SECTION -->
        <section class="info-grid">
            <div class="info-column">
                <div class="info-group">
                    <label for="clientName">Nama Klient</label>
                    <input type="text" id="clientName" placeholder="Masukkan nama klient" 
                           data-field="client">
                </div>
                <div class="info-group">
                    <label for="clientPhone">WhatsApp</label>
                    <input type="tel" id="clientPhone" placeholder="62812xxxxxxx" 
                           inputmode="numeric" maxlength="15" data-field="phone">
                </div>
            </div>
            <div class="info-column">
                <div class="info-group" id="eventDateGroup">
                    <label for="currentDate">Tanggal Acara</label>
                    <input type="date" id="currentDate" data-field="date">
                </div>
                <div class="info-group" id="locationGroup">
                    <label for="area">Lokasi & Durasi</label>
                    <div class="select-group">
                        <select id="area" aria-label="Area lokasi" data-field="area">
                            <option value="0">Dalam Wilayah (Free)</option>
                            <option value="300000">Pucungsari (+300rb)</option>
                            <option value="100000">Lebakharjo (+100rb)</option>
                            <option value="50000">Kaliuling (+50rb)</option>
                        </select>
                        <select id="days" aria-label="Durasi event" data-field="days">
                            <option value="0">1 Hari</option>
                            <option value="200000">2 Hari</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- ITEMS TABLE -->
        <section class="table-wrapper">
            <table id="itemTable" role="grid">
                <thead>
                    <tr>
                        <th width="50" style="text-align:center;">No</th>
                        <th>Deskripsi Jasa</th>
                        <th width="120" style="text-align:right; padding-right:15px;">Harga (IDR)</th>
                        <th width="40" class="no-print" style="text-align:center;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align:center; font-weight:700;">1</td>
                        <td>
                            <select class="paket-select" aria-label="Pilih layanan" data-field="service">
                                <option value="0">-- Pilih Layanan --</option>
                            </select>
                        </td>
<td>
    <input 
        type="text" 
        class="price-input" 
        inputmode="numeric"
        value="0"
        aria-label="Harga layanan"
        min="0"
        step="1000">
</td>
                        <td class="col-action no-print" style="text-align:center;">
                            <button class="btn-delete" aria-label="Hapus baris" 
                                    type="button" title="Hapus">‚úï</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- SUMMARY & PAYMENT SECTION -->
<section class="summary-wrapper">
    <div class="notes-box">
        <h3 class="notes-title">Catatan</h3>
        <p class="notes-text">
            DP minimal 30% dari Grand Total atau sesuai kesepakatan.
            Pelunasan maksimal H+3 setelah acara.
            File diserahkan setelah pelunasan.
        </p>
    </div>
</section>
                
<div class="payment-info">
    <p class="payment-info-title">INFO PEMBAYARAN :</p>
	  <span class="account-name"> A/N Adi Sofianto/Dejede</span>
    <div class="payment-methods">
<p class="rekening-line">
  <strong>BRI:</strong> 6320-0100-3835-533  

</p>
        <p><strong>DANA/ShopeePay:</strong> 6285236578999</p>
    </div>
</div>

            <div class="total-card">
                <div class="total-row">
                    <span>Sub-total</span>
                    <span id="sub" class="amount">Rp 0</span>
                </div>
                <div class="total-row">
                    <span>Tambahan Operasional</span>
                    <span id="extra" class="amount">Rp 0</span>
                </div>
                <div class="total-row">
                    <span>Diskon Khusus</span>
                    <input type="number" id="discount" value="0" min="0" step="1000" 
                           aria-label="Diskon" class="input-discount">
                </div>
                
                <div class="total-row grand">
                    <span>GRAND TOTAL</span>
                    <span id="grand" class="amount">Rp 0</span>
                </div>

                <div class="balance-section">
                    <div class="total-row">
                        <span>Uang Muka (DP)</span>
                        <input type="number" id="dp" value="0" min="0" step="1000" 
                               aria-label="Uang Muka" class="input-dp">
                    </div>
                    <div class="total-row balance">
                        <span>SISA BAYAR</span>
                        <span id="balance" class="amount">Rp 0</span>
                    </div>
                    <div id="paymentStatus" class="payment-status"></div>
                </div>
            </div>
        </section>

        <!-- FOOTER -->
<footer class="footer-banner">
    <div class="footer-content">
        <h3>Terima Kasih Atas Kepercayaan Anda</h3>
        <p>Semoga momen indah Anda abadi bersama layanan kami.</p>
        <div class="footer-branding">DEJEDE MANAGEMENT</div>
    </div>
</footer>

    <!-- LOADING INDICATOR (Hidden by default) -->
    <div id="loadingIndicator" class="loading-indicator" style="display:none;">
        <div class="spinner"></div>
        <p>Mengolah gambar...</p>
    </div>

<script>

// ================= DATA PAKET =================
const paketData = [
    {
        label: "WEDDING PACKAGE",
        items: [
            {nama: "Wedding Photo Gold", harga: 2500000},
            {nama: "Wedding Photo Silver", harga: 1100000},
            {nama: "Wedding Photo & Video Silver", harga: 1700000},
            {nama: "Wedding Photo Akad Basic", harga: 750000},
            {nama: "Engagement Photo & Video Teaser", harga: 1300000},
            {nama: "Engagement Photo Basic", harga: 750000},
            {nama: "Cinematic Video Wedding", harga: 1500000},
            {nama: "Video Dokumentasi", harga: 700000}
        ]
    },
    {
        label: "NON-WEDDING / PREWED",
        items: [
            {nama: "Engagement Photo & Video", harga: 1300000},
            {nama: "Prewedding Studio", harga: 600000},
            {nama: "Prewedding Outdoor", harga: 800000},
            {nama: "Family Photo Studio", harga: 300000},
            {nama: "Tedak Sinten Photo", harga: 600000},
            {nama: "Ulang Tahun Photo", harga: 600000}
        ]
    },
    {
        label: "CETAK FOTO",
        items: [
            {nama: "Cetak photo 10rs + Pigura", harga: 55000},
            {nama: "Cetak photo 12rs + Pigura", harga: 150000},
            {nama: "Cetak photo 16rs + Pigura", harga: 285000},
            {nama: "Cetak photo 20rs + Pigura", harga: 400000},
            {nama: "Cetak photo 24rs + Pigura", harga: 500000}
        ]
    },
    {
        label: "EDITING",
        items: [
            {nama: "Editing Standart", harga: 20000},
            {nama: "Editing Semifull", harga: 30000},
            {nama: "Editing Full", harga: 50000}
        ]
    }
];

// ================= UTILITIES =================

/**
 * Format number to Indonesian currency
 */
function formatCurrency(value) {
    const num = parseFloat(value) || 0;
    return "Rp " + num.toLocaleString("id-ID");
}

/**
 * Format phone number
 */
function formatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    
    // Batas max 15 digit
    if (value.length > 15) value = value.slice(0, 15);
    
    // Tambahkan formatting visual (opsional)
    if (value.length > 4) {
        value = value.slice(0, 4) + '-' + value.slice(4);
    }
    
    input.value = value;
}

/**
 * Validate phone number
 */
function validatePhone(phone) {
    const cleaned = phone.replace(/\D/g, '');
    return cleaned.length >= 10 && cleaned.length <= 15;
}

/**
 * Parse phone number to WhatsApp format
 */
function parsePhoneToWA(phone) {
    let cleaned = phone.replace(/\D/g, '');
    
    if (cleaned.startsWith('0')) {
        cleaned = '62' + cleaned.slice(1);
    } else if (!cleaned.startsWith('62')) {
        cleaned = '62' + cleaned;
    }
    
    return cleaned;
}

/**
 * Get element by ID safely
 */
const $ = (id) => document.getElementById(id);

// ================= INITIALIZE =================
document.addEventListener("DOMContentLoaded", function() {

    $('currentDate').valueAsDate = new Date();

    renderAllDropdown();
    attachEventListeners();
    toggleEventFields();
    updateInvoice();

});

// ================= EVENT LISTENERS =================
function attachEventListeners() {

    // ===== INVOICE AUTO UPDATE =====
    $('clientName').addEventListener('input', updateInvoice);
    $('clientPhone').addEventListener('input', updateInvoice);
    $('currentDate').addEventListener('change', updateInvoice);

    // ===== CONTROL BUTTONS =====
    document.querySelectorAll('.controls-wrapper .btn').forEach(btn => {
        btn.addEventListener('click', handleButtonClick);
    });

    // ===== AREA & DAYS =====
    $('area').addEventListener('change', () => {
        calculate();
        toggleEventFields();
    });

    $('days').addEventListener('change', () => {
        calculate();
        toggleEventFields();
    });

    $('discount').addEventListener('input', calculate);
    $('dp').addEventListener('input', calculate);

    // ===== PHONE FORMAT =====
    $('clientPhone').addEventListener('input', function() {
        formatPhone(this);
    });

    // ===== PAKET CHANGE =====
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('paket-select')) {
            updateRowPrice(e.target);
        }
    });

    // ===== FORMAT RUPIAH =====
    document.addEventListener("input", function(e) {

        if (!e.target.classList.contains("price-input")) return;

        let input = e.target;
        let angka = input.value.replace(/\D/g, "");

        if (angka === "") {
            input.value = "";
        } else {
            input.value = "Rp. " + Number(angka).toLocaleString("id-ID");
        }

        calculate();
    });
}

/**
 * Handle control button clicks
 */
function handleButtonClick(e) {
    const action = e.currentTarget.getAttribute('data-action');
    
    switch(action) {
        case 'save':
            saveAsJpeg();
            break;
        case 'whatsapp':
            sendWhatsApp();
            break;
        case 'add-row':
            addRow();
            break;
        case 'print':
            window.print();
            break;
    }
}

// ================= RENDER FUNCTIONS =================

/**
 * Render dropdown with package options
 */
function renderDropdown(select) {
    select.innerHTML = `<option value="0" data-price="0">-- Pilih Layanan --</option>`;
    
    paketData.forEach(group => {
        const optGroup = document.createElement("optgroup");
        optGroup.label = group.label;
        
        group.items.forEach(item => {
            const opt = document.createElement("option");
            opt.textContent = item.nama;
            opt.setAttribute("data-price", item.harga);
            optGroup.appendChild(opt);
        });
        
        select.appendChild(optGroup);
    });
}

/**
 * Render all dropdowns in table
 */
function renderAllDropdown() {
    document.querySelectorAll(".paket-select").forEach(s => renderDropdown(s));
}

// ================= CALCULATION & UPDATE FUNCTIONS =================

function updateInvoice() {

    const name = $('clientName')?.value.trim() || "";
    const phone = $('clientPhone')?.value.replace(/\D/g, '') || "";
    const dateValue = $('currentDate')?.value;

    if (!dateValue) return;

    const d = new Date(dateValue);

    // Inisial
    let initials = "XX";
    if (name) {
        const words = name.split(" ").filter(w => w.length > 0);
        if (words.length >= 2) {
            initials = (words[0][0] + words[1][0]).toUpperCase();
        } else {
            initials = name.substring(0, 2).toUpperCase();
        }
    }

    // 2 digit terakhir HP
    let lastTwoPhone = phone.length >= 2 ? phone.slice(-2) : "00";

    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = String(d.getFullYear()).slice(-2);

    $('invoiceNum').value =
        `INV/DJD/${initials}/${lastTwoPhone}/${day}${month}${year}`;
}

/*** Calculate all totals */
function calculate() {
    // Calculate subtotal
    let sub = 0;
    document.querySelectorAll(".price-input").forEach(input => {
        sub += parseFloat(input.value.replace(/\D/g, '')) || 0;
    });

    // Calculate extra (area + days)
    const extra = (parseFloat($('area').value) || 0) +
                  (parseFloat($('days').value) || 0);

    // Get discount & DP
    const disc = parseFloat($('discount').value) || 0;
    const dp = parseFloat($('dp').value) || 0;

    // Calculate grand total & balance
    const grand = Math.max(0, sub + extra - disc);
    const balance = Math.max(0, grand - dp);

    // Update display
    $('sub').innerText = formatCurrency(sub);
    $('extra').innerText = formatCurrency(extra);
    $('grand').innerText = formatCurrency(grand);
    $('balance').innerText = formatCurrency(balance);

    // Update watermark & payment status
    updatePaymentStatus(grand, balance);
}

/**
 * WATERMARK - LUNAS 
 */
function updatePaymentStatus(grand, balance) {

    const wm = $('paidWatermark');
    const st = $('paymentStatus');

    if (grand > 0 && balance === 0) {

        wm.style.opacity = "0.12";
        wm.innerText = "LUNAS";

        st.innerText = "‚úì LUNAS / PAID";
        st.style.color = "#2ecc71";

    } else {

        wm.style.opacity = "0";
        st.innerText = balance > 0 ? "‚è≥ MENUNGGU PELUNASAN" : "";
        st.style.color = "#f1c40f";
    }
}

/**
 * Toggle event date & location fields based on selected services
 */
function toggleEventFields() {
    const selects = document.querySelectorAll(".paket-select");
    let allNoEvent = true;
    const noEventCategories = ["CETAK FOTO", "EDITING"];

    selects.forEach(select => {
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.parentElement.label) {
            const groupLabel = selectedOption.parentElement.label;
            if (!noEventCategories.includes(groupLabel) && selectedOption.value !== "0") {
                allNoEvent = false;
            }
        }
    });

    const eventDate = $('eventDateGroup');
    const location = $('locationGroup');
    
    eventDate.style.display = allNoEvent ? "none" : "block";
    location.style.display = allNoEvent ? "none" : "block";
}

// ================= ROW MANAGEMENT =================

/**
 * Add new row to table
 */
function addRow() {
    const tbody = document.querySelector("#itemTable tbody");
    const rowNum = tbody.rows.length + 1;
    
    const row = tbody.insertRow();
    row.innerHTML = `
        <td style="text-align:center; font-weight:700;">${rowNum}</td>
        <td>
            <select class="paket-select" aria-label="Pilih layanan" data-field="service">
                <option value="0">-- Pilih Layanan --</option>
            </select>
        </td>
        <td>
				<input type="text" class="price-input" inputmode="numeric" value="0"
					aria-label="Harga layanan">
        </td>
        <td class="col-action no-print" style="text-align:center;">
            <button class="btn-delete" aria-label="Hapus baris" type="button">‚úï</button>
        </td>
    `;
    
    renderDropdown(row.querySelector(".paket-select"));
    
    // Attach listener to delete button
    row.querySelector(".btn-delete").addEventListener('click', function() {
        removeRow(this);
    });
}

/**
 * Remove row from table
 */
function removeRow(btn) {
    // Confirm deletion
    if (!confirm('Yakin ingin menghapus baris ini?')) return;
    
    btn.closest("tr").remove();
    
    // Update row numbers
    document.querySelectorAll("#itemTable tbody tr").forEach((row, i) => {
        row.cells[0].innerText = i + 1;
    });
    
    calculate();
}

// ================= WHATSAPP FUNCTION =================

/**
 * Send invoice via WhatsApp
 */
function sendWhatsApp() {
    const name = $('clientName').value || "Pelanggan";
    const phone = $('clientPhone').value;
    const inv = $('invoiceNum').value;
    const grand = $('grand').innerText;
    const balance = $('balance').innerText;

    // Validate phone
    if (!phone) {
        alert("‚ö†Ô∏è Isi nomor WhatsApp klien dulu, Bos!");
        return;
    }

    if (!validatePhone(phone)) {
        alert("‚ö†Ô∏è Nomor WhatsApp tidak valid!");
        return;
    }

    // Build service list
    let detail = "";
    let hasItem = false;

    document.querySelectorAll("#itemTable tbody tr").forEach((row, i) => {
        const sel = row.querySelector(".paket-select");
        const txt = sel.options[sel.selectedIndex].text;
        const prc = row.querySelector(".price-input").value;

        if (txt && !txt.includes("--")) {
            hasItem = true;
            const cleanNumber = prc.replace(/\D/g, '') || 0;
			const formattedPrice = Number(cleanNumber).toLocaleString('id-ID');
            detail += `${i + 1}. ${txt}\n    Rp ${formattedPrice}\n\n`;
        }
    });

    if (!hasItem) {
        alert("‚ö†Ô∏è Belum ada layanan yang dipilih, Bos!");
        return;
    }

    // Construct message
    const msg = `*üì∑ INVOICE DEJEDE PHOTOGRAPHY*

Halo *${name}* üëã

Berikut detail pesanan Anda:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìå *No Invoice:* ${inv}

üìã *Layanan:*
${detail}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ *TOTAL: ${grand}*
üí≥ *SISA BAYAR: ${balance}*

üè¶ *INFO PEMBAYARAN*
‚Ä¢ BRI: 6320-0100-3835-533 A/N Adi Sofianto
‚Ä¢ DANA/ShopeePay: 6285236578999

Mohon konfirmasi jika sudah melakukan pembayaran.
Terima kasih! üôè

#DejedePhotography`;

    const cleanPhone = parsePhoneToWA(phone);
    window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
}

function updateRowPrice(select) {

    const price = select.options[select.selectedIndex].getAttribute("data-price") || 0;
    const input = select.closest("tr").querySelector(".price-input");

    if (price == 0) {
        input.value = "";
    } else {
        input.value = "Rp. " + Number(price).toLocaleString("id-ID");
    }

    calculate();
    toggleEventFields();
}


// ================= EXPORT JPG FUNCTION =================

/**
 * Save invoice as JPEG
 */
function saveAsJpeg() {
    const container = $('invoice-container');
    const clientName = $('clientName').value || 'Dejede';
    
    // Show loading
    const loader = $('loadingIndicator');
    loader.style.display = 'flex';

    // Enable export mode
    container.classList.add("is-exporting");

    html2canvas(container, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        allowTaint: true,

        // üî• TAMBAHAN INI SAJA
        ignoreElements: function(element) {
            return element.id === 'loadingIndicator';
        }

    }).then(canvas => {
        const link = document.createElement("a");
        link.download = `Invoice-${clientName}-${new Date().toISOString().split('T')[0]}.jpg`;
        link.href = canvas.toDataURL("image/jpeg", 0.92);
        link.click();

        container.classList.remove("is-exporting");
        loader.style.display = 'none';
    }).catch(err => {
        console.error("Error saving image:", err);
        alert("‚ö†Ô∏è Gagal menyimpan gambar. Silahkan coba lagi.");
        container.classList.remove("is-exporting");
        loader.style.display = 'none';
    });
}


// ================= AUTO FORMAT RUPIAH (GLOBAL & STABLE) =================
document.addEventListener("input", function(e) {

    if (!e.target.classList.contains("price-input")) return;

    let input = e.target;
    let angka = input.value.replace(/\D/g, "");

    if (angka === "") {
        input.value = "";
    } else {
        input.value = "Rp. " + Number(angka).toLocaleString("id-ID");
    }

    calculate();
});
</script>


</body>
</html>
